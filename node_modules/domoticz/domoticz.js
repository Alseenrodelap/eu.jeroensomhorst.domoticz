'use strict';
const http = require('http');
const Homey = require('homey');

const defaultPort = 8080;
const defaultPassword = '';

const deviceListPath = '/json.htm?type=devices&used=true';

class Domoticz{

    constructor(uname,password,host,port){
        console.log("New Domoticz instance");
        this.uname = uname || '';
        this.password = password || defaultPassword;
        this.port = port || defaultPort;
        this.host = host;

        this.authToken = new Buffer(this.uname+":"+this.password).toString('base64');
        this.authHeader = 'Basic '+this.authToken;
    }

    // load domoticz from homey settings
    static fromSettings(){
        console.log("Retrieve connector from settings");
        let settings = Homey.ManagerSettings.get('domotics_config');
        if(settings) {
            return new Domoticz(settings.username, settings.password, settings.host, settings.port);
        }
        return null;
    }
    // get an 'unique' prefix to be used in the drivers
    getHostString(){
        return this.host+":"+this.port;
    }

    updateDevice(type,idx,command,passcode){
        let path = "/json.htm?type=command";
        path += "&param="+type;
        path += "&idx="+idx;

        switch(type){
            case 'setsetpoint':
                path += "&setpoint="+command;
                break;
            case 'switchlight':
                path += "&switchcmd="+command;
                break;
        }

        if(passcode){
            path += "&passcode="+passcode;
        }

        return this._makeHttpRequest(path).then((data)=>{
                let body = JSON.parse(data.body);
                return (body.status === 'OK');
            }).catch((error)=>{
                Homey.app.doLog("Error while updating device");
                Homey.app.doError(error);
                return false;
            });


    }

    // retrieve the first device of the given type
    findDevice(type,subtype){

        return new Promise((resolve,reject)=>{
            this._makeHttpRequest(deviceListPath).then(
                (data)=>{
                    let body = JSON.parse(data.body);
                    if(body.status === "OK"){
                        if(type == null && subtype == null){
                            return resolve(body.result);
                        }
                        throw Error('No device found!');
                        
                    }else{
                        Homey.app.doError("Invalid status received from data");
                        throw Error('invalid state from domoticz');
                    }
                    
                }).catch((error)=>{
                    Homey.app.doError('Error while connecting??');
                    this.authToken = null;
                    return reject(error);
                });
        });



        
    }

    doLogin(){
        //Homey.app.doLog("Start logging into system");

        return new Promise((resolve,reject)=>{
            this._makeHttpRequest(deviceListPath).then(
                (data)=>{
                    if(data.body.status ==='OK'){
                        return resolve(true);
                    }else{
                        return reject(false);
                    }
                    
                }).catch((error)=>{
                    Homey.app.doError('Error while logging into system??');
                    this.authToken = null;
                    return reject(error);
                });
        });
    }


    _makeHttpRequest(path){
        return new Promise((resolve,reject)=>{
            let req  = http.get({
                host: this.host,
                port: this.port,
                path: path,
                headers: {
                  'Content-length': 0,
                  'Authorization': this.authHeader
                },
            },(res)=>{
                let requestData = [];

                res.on('data',(chunk)=>{
                    //requestData += chunk
                    requestData.push(chunk);
                });

                res.on('end',()=>{
                    resolve({
                        "body":  Buffer.concat(requestData)
                    });
                });

                req.on('error',(err)=>{
                    Homey.app.doLog("Error while connecting to domoticz");
                    Homey.app.doLog(err);
                    reject(err);
                });
            }).on('error',(e)=>{
                Homey.app.doLog('Error!!');
                reject(e);
            });



            
        });
    }

}

module.exports = Domoticz;